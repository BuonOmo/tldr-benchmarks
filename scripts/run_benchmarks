#!/usr/bin/env bash
#
# Run benchmarks once commands are built.
# This will look at `command_list.csv` for
# the list of commands to benchmark.
#
# `command_list.csv` format:
#
#     <cache_environment_variable>,<command_to_run>
#
# Arguments:
#
#  - $1 => Command to clear OS file system caches.

CLEAR_CACHE_CMD="$1"

shift || {
	>&2 echo "Usage: $0 <clear_cache_command>"
	exit 1
}

echo "Commands to benchmark:"
echo
column -ts , <command_list.csv
echo
benchmarks_tar=()
benchmarks_update=()
while IFS=, read env cmd; do
	cache_path="$PWD/caches/$cmd"
	mkdir -p "$cache_path"
	bash -c "$CLEAR_CACHE_CMD"
	timing_s=$({ time bash -c "$env=\"$cache_path\" ./$cmd --update"; } 2>&1 | awk '/real/ {print $2}')
	echo "Updating cache for $cmd in $timing_s."
	echo "$cmd,$timing_s" >>update_times.csv
	benchmarks_tar+=("$env=\"$cache_path\" ./$cmd tar")
	benchmarks_update+=("$env=\"$cache_path\" ./$cmd --update")
done <command_list.csv
hyperfine \
	--warmup 10 \
	--prepare "$CLEAR_CACHE_CMD" \
	--export-json hyperfine_tar.json \
	"${benchmarks_tar[@]}"
hyperfine \
	--warmup 10 \
	--prepare "$CLEAR_CACHE_CMD" \
	--export-json hyperfine_update.json \
	"${benchmarks_update[@]}"
mkdir export
mv hyperfine_tar.json export/
mv hyperfine_update.json export/
mv update_times.csv export/
